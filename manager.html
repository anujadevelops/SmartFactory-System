<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manager Control Center | SmartFactory</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CORE THEME (PRESERVED) --- */
        body { background: #1e293b; color: white; font-family: 'Segoe UI', sans-serif; padding: 0; margin: 0; display: flex; overflow: hidden; }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .sidebar { width: 250px; background: #0f172a; height: 100vh; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.05); }
        .sidebar h2 { color: #fff; margin-bottom: 40px; font-size: 20px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; color: #94a3b8; display: flex; align-items: center; gap: 10px; text-decoration: none; margin-bottom: 5px; border-radius: 8px; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { color: #7cf2d6; background: rgba(124, 242, 214, 0.1); }
        
        .main { flex: 1; padding: 30px; overflow-y: auto; height: 100vh; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        .card { background: #334155; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        h3 { margin-top: 0; color: #7cf2d6; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* --- FEATURE STYLES --- */
        
        /* 1. Client Order List */
        .order-box {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
        }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #1e293b; color: #94a3b8; text-align: left; padding: 12px; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid rgba(255,255,255,0.1); z-index: 10; }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; color: #cbd5e1; }
        
        /* 2. Intelligent Toasts */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: rgba(15, 23, 42, 0.95); border-left: 4px solid #7cf2d6; color: white;
            padding: 15px 20px; border-radius: 6px; box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            animation: slideIn 0.3s ease-out; min-width: 280px; display: flex; align-items: center; gap: 12px; backdrop-filter: blur(5px);
        }
        .toast.warning { border-left-color: #f1c40f; }
        .toast.alert { border-left-color: #ff6b6b; }
        .toast-content { display: flex; flex-direction: column; }
        .toast-title { font-weight: bold; font-size: 13px; margin-bottom: 2px; }
        .toast-msg { font-size: 12px; opacity: 0.8; }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* 3. Production Output Tracking Styles */
        .stock-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .stock-row:hover { background: rgba(255,255,255,0.02); }
        .prod-label { font-size: 13px; font-weight: bold; color: #cbd5e1; }
        .prod-qty { font-size: 11px; color: #7cf2d6; font-family: monospace; }

        /* 4. Profit & Loss Section */
        .pl-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .pl-metric { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; position: relative; overflow: hidden; }
        .pl-label { font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .pl-value { font-size: 20px; font-weight: bold; color: white; }
        .pl-trend { font-size: 11px; margin-top: 5px; }
        .trend-up { color: #2ecc71; }
        .trend-down { color: #ff6b6b; }
        
        /* Utility Buttons */
        .btn-action { background: #7cf2d6; color: #0f172a; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 12px; display: inline-flex; align-items: center; gap: 8px; }
        .btn-action:hover { background: #fff; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid #7cf2d6; color: #7cf2d6; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; transition: 0.2s; }
        .btn-outline:hover { background: rgba(124, 242, 214, 0.1); color: white; }
        .btn-dispatch { width: 100%; margin-top: 15px; background: #7cf2d6; color: #0f172a; padding: 10px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; }

        /* Report Feed */
        .report-feed { max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
        .report-msg { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; display: flex; gap: 10px; align-items: flex-start; }
        .report-source { font-weight: bold; min-width: 90px; font-size: 11px; text-transform: uppercase; margin-top: 2px; }
        .source-op { color: #7cf2d6; }
        .source-an { color: #f1c40f; }
        .source-ai { color: #4facfe; }

        /* --- NOTIFICATION DROPDOWN --- */
        .notif-container { position: relative; margin-right: 20px; cursor: pointer; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: #ff6b6b; color: white; border-radius: 50%; width: 15px; height: 15px; font-size: 10px; display: flex; justify-content: center; align-items: center; font-weight: bold; display: none; }
        .notif-dropdown { display: none; position: absolute; top: 30px; right: 0; width: 300px; background: #334155; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .notif-item { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; color: #cbd5e1; }

        /* --- REPORT MODAL --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; }
        .modal-box { background: #1e293b; padding: 25px; border-radius: 12px; width: 500px; border: 1px solid #7cf2d6; color: white; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #7cf2d6; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; display: flex; justify-content: space-between; }
        .modal-body { font-family: monospace; line-height: 1.5; color: #cbd5e1; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }

    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="reportModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <span>Report Details</span>
            <i class="fas fa-times" style="cursor:pointer;" onclick="closeReportModal()"></i>
        </div>
        <div class="modal-body" id="reportModalContent"></div>
    </div>
</div>

<div class="sidebar">
    <h2><i class="fas fa-layer-group" style="color:#7cf2d6"></i> SmartFactory</h2>
    <div style="flex-grow: 1;">
        <a href="#" class="nav-item active"><i class="fas fa-columns"></i> Dashboard</a>
        <a href="#" class="nav-item"><i class="fas fa-boxes"></i> Inventory</a>
        <a href="#" class="nav-item"><i class="fas fa-clipboard-check"></i> Client Order</a>
        <a href="#" class="nav-item"><i class="fas fa-chart-line"></i> Live Feed</a>
    </div>
    
    <div class="card" style="padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);">
        <div style="font-size: 10px; color: #94a3b8; margin-bottom: 8px; font-weight: bold;">System Refresh</div>
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <div id="commsStatus" style="width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; box-shadow: 0 0 8px #2ecc71;"></div>
            <span style="font-size: 11px; color: #cbd5e1;">Auto-Sync: Active (1h)</span>
        </div>
        <button class="btn-outline" style="width: 100%;" onclick="location.reload()">
            <i class="fas fa-sync"></i> Manual Refresh
        </button>
    </div>

    <div style="margin-top: 10px;">
        <a href="/logout" class="nav-item"><i class="fas fa-sign-out-alt"></i> Log Out</a>
    </div>
</div>

<div class="main">
    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 24px;">Manager Control Center</h1>
            <span style="color:#94a3b8; font-size:13px;" id="liveClock">Loading System Time...</span>
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div class="notif-container" onclick="toggleNotifDropdown()">
                <i class="fas fa-bell" style="font-size: 20px; color: #94a3b8;"></i>
                <div class="notif-badge" id="notifBadge">0</div>
                <div class="notif-dropdown" id="notifDropdown">
                    <div style="padding:10px; font-weight:bold; font-size:12px; background:#1e293b; border-bottom:1px solid rgba(255,255,255,0.1);">INBOX</div>
                    <div id="notifList">
                        <div style="padding:10px; color:#64748b; font-size:11px;">No new messages</div>
                    </div>
                </div>
            </div>
            <button class="btn-action" onclick="generateEODReport()"><i class="fas fa-file-pdf"></i> Generate EOD Report</button>
        </div>
    </div>

    <div class="card">
        <h3>
            <span><i class="fas fa-coins"></i> Live Financial Intelligence</span>
            <span style="font-size:11px; color:#94a3b8;"><i class="fas fa-sync fa-spin"></i> Real-time</span>
        </h3>
        <div class="pl-grid">
            <div class="pl-metric">
                <div class="pl-label">Total Revenue</div>
                <div class="pl-value" id="plRevenue">₹0.00</div>
                <div class="pl-trend trend-up"><i class="fas fa-arrow-up"></i> Yield Driven</div>
            </div>
            <div class="pl-metric">
                <div class="pl-label">Operational Costs</div>
                <div class="pl-value" id="plCost" style="color: #ff6b6b;">₹0.00</div>
                <div class="pl-trend trend-down"><i class="fas fa-arrow-down"></i> Energy & Material</div>
            </div>
            <div class="pl-metric" style="border: 1px solid rgba(124, 242, 214, 0.2);">
                <div class="pl-label">Net Profit (Session)</div>
                <div class="pl-value" id="plProfit">₹0.00</div>
                <div class="pl-trend trend-up" id="marginText">Margin: 0%</div>
            </div>
            <div class="pl-metric">
                <div class="pl-label">Total Completed Yield</div>
                <div class="pl-value" id="totalYield">0 Units</div>
                <div class="pl-trend" style="color: #f1c40f;">Live Production</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3><span><i class="fas fa-industry"></i> Live Production Output Tracker</span></h3>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            
            <div id="productionList" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; max-height: 240px; overflow-y: auto;">
                </div>

            <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                <label style="font-size: 11px; color: #94a3b8; font-weight:bold;">MATERIAL RESTOCK</label>
                <select id="dispatchSelect" style="width: 100%; padding: 10px; margin-top: 5px; background: #0f172a; color: white; border: 1px solid #475569; border-radius: 6px;">
                </select>
                
                <label style="font-size: 11px; color: #94a3b8; display: block; margin-top: 15px; font-weight:bold;">ORDER QUANTITY</label>
                <input type="number" id="dispatchQty" value="500" style="width: 100%; padding: 10px; margin-top: 5px; background: #0f172a; color: white; border: 1px solid #475569; border-radius: 6px;">
                <label style="font-size: 11px; color: #94a3b8; display: block; margin-top: 15px; font-weight:bold;">DEADLINE</label>
    <input type="date" id="dispatchDeadline" style="width: 100%; padding: 10px; margin-top: 5px; background: #0f172a; color: white; border: 1px solid #475569; border-radius: 6px;">
                <button class="btn-dispatch" onclick="dispatchMaterial()">
                    <i class="fas fa-shipping-fast"></i> SEND ORDER
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3><span><i class="fas fa-shopping-cart"></i> Client Order Stream</span></h3>
        <div class="order-box">
            <table id="clientOrderTable">
                <thead>
                    <tr><th>Order ID</th><th>Product</th><th>Quantity</th><th>Value</th><th>Deadline</th><th>Status</th></tr>
                </thead>
                <tbody id="clientOrderBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h3><i class="fas fa-satellite-dish"></i> Live Intelligence Feed</h3>
        <div class="report-feed" id="mainReportFeed"></div>
    </div>
</div>

<script>
    const socket = io();
    let clientOrders = [];
    let activeOrders = [];
    let notifCount = 0;
    let financials = { revenue: 0, cost: 0 };

    window.onload = function() {
        startClock();
        renderProductionTracker(); // Ensure bars are 0 on load
        showToast("Manager Command Center Online", "Production Monitoring Active", "success");
    };

    socket.on('system_update', (data) => {
        // 1. Sync Live Financials
        if(data.financials) {
            financials.revenue = data.financials.revenue;
            financials.cost = data.financials.cost;
            updateFinancialsUI();
        }
        // 2. Sync Total Factory Yield
        if(data.yield !== undefined) {
            document.getElementById('totalYield').innerText = data.yield.toLocaleString() + " Units";
        }
        // 3. Fill Dispatch Dropdown if empty
 const select = document.getElementById('dispatchSelect');
    if(data.inventory && select.children.length === 0) {
        data.inventory.forEach(item => {
            let opt = new Option(item.name, item.name);
            select.add(opt);
        });
    }
        // 4. Load Initial Client Orders
        if(data.client_orders) {
            clientOrders = data.client_orders;
            renderClientOrders();
        }
    });

    // TRIGGER: When Operator Completes a Task
    socket.on('order_update', (orders) => {
        activeOrders = orders;
        renderProductionTracker(); 
    });

    socket.on('new_client_order', (order) => {
        clientOrders.unshift(order);
        renderClientOrders();
        showToast("New Web Order", order.id, "success");
        addNotification(`New Sales Order: ${order.id}`, "Order");
    });

    socket.on('report_update', (reports) => {
        const feed = document.getElementById('mainReportFeed');
        feed.innerHTML = reports.map(r => {
            const role = r.author.toLowerCase().includes("operator") ? "source-op" : "source-an";
            return `<div class="report-msg"><div class="report-source ${role}">${r.author}</div><div style="flex:1; color:#cbd5e1;">${r.content}</div><div style="font-size:11px; color:#64748b;">${r.timestamp.split(' ')[1]}</div></div>`;
        }).join('');
    });

    function updateFinancialsUI() {
        const profit = financials.revenue - financials.cost;
        const margin = financials.revenue > 0 ? (profit / financials.revenue) * 100 : 0;
        document.getElementById('plRevenue').innerText = `₹${financials.revenue.toLocaleString()}`;
        document.getElementById('plCost').innerText = `₹${Math.floor(financials.cost).toLocaleString()}`;
        const elProfit = document.getElementById('plProfit');
        elProfit.innerText = `₹${Math.floor(profit).toLocaleString()}`;
        elProfit.style.color = profit >= 0 ? '#2ecc71' : '#ff6b6b';
        document.getElementById('marginText').innerText = `Margin: ${margin.toFixed(1)}%`;
    }

 // Inside manager.html -> function renderProductionTracker()
function renderProductionTracker() {
    const list = document.getElementById('productionList');
    const prodSummary = {};
    
    activeOrders.filter(o => o.status === 'Completed').forEach(o => {
        prodSummary[o.product] = (prodSummary[o.product] || 0) + o.quantity;
    });

    // UPDATED: Now tracks all 10 inventory items
    const products = [
        "Steel Sheets", "Copper Wire", "Lubricant", "Microchips", 
        "Hydraulic Valve", "Piston Ring", "Neural Chip", 
        "Circuit Board", "Sensor Unit", "Nano-Fiber Chassis"
    ];
    
    list.innerHTML = products.map(prod => {
        const completed = prodSummary[prod] || 0;
        const goal = 2000; // Adjusted visual goal for the bars
        const pct = Math.min(100, (completed / goal) * 100);
        return `
            <div class="stock-row">
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:bold;">
                        <span class="prod-label">${prod}</span>
                        <span class="prod-qty">${completed} / ${goal} Units Produced</span>
                    </div>
                    <div style="height:6px; background:rgba(255,255,255,0.1); margin-top:8px; border-radius:3px; overflow:hidden;">
                        <div style="width:${pct}%; height:100%; background:#7cf2d6; transition:width 1s;"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function dispatchMaterial() {
    const item = document.getElementById('dispatchSelect').value;
    const qty = parseInt(document.getElementById('dispatchQty').value);
    const deadline = document.getElementById('dispatchDeadline').value; // Capture deadline

    if(!qty || qty <= 0) return alert("Please enter a valid quantity.");
    if(!deadline) return alert("Please select a deadline for the AI to calculate priority.");

    fetch('/api/create_order', { 
        method: 'POST', 
        headers: {'Content-Type':'application/json'}, 
        body: JSON.stringify({ 
            product: item, 
            quantity: qty,
            deadline: deadline // Send deadline to backend
        }) 
    })
    .then(() => {
        showToast("Dispatch Sent", `${item} with deadline ${deadline}`, "success");
        socket.emit('ai_command', { 
            notification_to_operator: true, 
            message: `MANAGER: Restock order for ${item} (x${qty}) due by ${deadline}.` 
        });
    });
}

    function renderClientOrders() {
        const tbody = document.getElementById('clientOrderBody');
        tbody.innerHTML = clientOrders.map(o => `<tr><td><strong>${o.id}</strong></td><td>${o.product}</td><td>${o.qty.toLocaleString()}</td><td style="color:#7cf2d6">₹${o.amt.toLocaleString()}</td><td>${o.deadline}</td><td><span style="font-size:10px; background:#1e293b; padding:2px 5px; border-radius:4px;">${o.status}</span></td></tr>`).join('');
    }
// Update the renderClientOrders function to calculate AI Priority
    function renderClientOrders() {
        const tbody = document.getElementById('clientOrderBody');
        const today = new Date();

        tbody.innerHTML = clientOrders.map(o => {
            const deadlineDate = new Date(o.deadline);
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let priority = "LOW";
            let color = "#94a3b8"; // Muted Gray

            // AI Priority Logic
            if (diffDays <= 2) {
                priority = "CRITICAL";
                color = "#ff6b6b"; // Red
            } else if (diffDays <= 5) {
                priority = "HIGH";
                color = "#f1c40f"; // Yellow/Orange
            } else if (diffDays <= 10) {
                priority = "MEDIUM";
                color = "#7cf2d6"; // Cyan
            }

            return `
                <tr>
                    <td><strong>${o.id}</strong></td>
                    <td>${o.product}</td>
                    <td>${o.qty.toLocaleString()}</td>
                    <td style="color:#7cf2d6">₹${o.amt.toLocaleString()}</td>
                    <td>${o.deadline}</td>
                    <td>
                        <span style="font-size:10px; background:${color}; color:#1a2a33; padding:4px 8px; border-radius:12px; font-weight:bold;">
                            ${priority}
                        </span>
                    </td>
                </tr>`;
        }).join('');
    }
    function startClock() { setInterval(() => { document.getElementById('liveClock').innerHTML = `<i class="far fa-clock"></i> ${new Date().toLocaleString()}`; }, 1000); }
    function toggleNotifDropdown() { const dd = document.getElementById('notifDropdown'); dd.style.display = dd.style.display === 'block' ? 'none' : 'block'; if(dd.style.display === 'block') document.getElementById('notifBadge').style.display='none'; }
    function addNotification(msg, type) { const list = document.getElementById('notifList'); if(list.innerText.includes("No new messages")) list.innerHTML = ""; const div = document.createElement('div'); div.className='notif-item'; div.innerHTML=`<strong>${type}:</strong> ${msg}`; list.prepend(div); notifCount++; document.getElementById('notifBadge').innerText=notifCount; document.getElementById('notifBadge').style.display='flex'; }
    function showToast(title, msg, type="info") { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type==='error'?'alert':''}`; toast.innerHTML=`<div class="toast-content"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div>`; container.appendChild(toast); setTimeout(()=>toast.remove(), 4000); }
    function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }
 
    // UPDATED: Aggregates Operator and Analyst logs into a single EOD file
async function generateEODReport() {
    showToast("EOD CONSOLIDATION", "Fetching shift intel from all nodes...");
    
    try {
        const res = await fetch('/api/reports');
        const reports = await res.json();
        
        // Filter and format reports from the current session
        const consolidatedIntel = reports.map(r => `[${r.timestamp}] [${r.author}] ${r.content}`).join('\n');
        
        const finalEOD = `
        END OF DAY PRODUCTION SUMMARY
        -----------------------------
        Date: ${new Date().toLocaleDateString()}
        Final Revenue: ${document.getElementById('plRevenue').innerText}
        Final Cost: ${document.getElementById('plCost').innerText}
        Total Units: ${document.getElementById('totalYield').innerText}
        
        SHIFT INTEL & DISPATCHES:
        ${consolidatedIntel}
        `;

        const blob = new Blob([finalEOD], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `EOD_Consolidated_Report.txt`;
        a.click();
        
        showToast("SUCCESS", "Consolidated Report Dispatched to Analyst Node Archive.");
    } catch (err) {
        showToast("ERROR", "Uplink failure during consolidation.");
    }
}
</script>
</body>
</html>